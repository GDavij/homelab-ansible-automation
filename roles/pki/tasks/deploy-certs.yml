- name: Ensure PKI Directories Exists on Hosts
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    mode: '0755'
  become: true
  loop:
    - /etc/pki/homelab/certs
    - /etc/pki/homelab/private
  tags:
    - pki
    - upload

- name: Deploy Root Certificate Authority
  ansible.builtin.copy:
    src: "{{ pki_output_folder }}/authorities/root-ca.crt"
    dest: "/etc/pki/homelab/certs/root-ca.crt"
    mode: '0644'
  become: true
  tags:
    - pki
    - upload

- name: Deploy Service Certificate for Hosts
  ansible.builtin.copy:
    src: "{{ pki_output_folder }}/{{ item.0.name }}.{{ item.1.ext }}"
    dest: "/etc/pki/homelab/{{ item.1.dir }}/{{ item.0.name }}.{{ item.1.ext }}"
    owner: root
    group: "{{ ssl_cert_group | default('root') }}"
    mode: "{{ item.1.mode }}"
  become: true
  with_nested:
    - "{{ pki_services }}"
    - - { ext: 'crt', dir: 'certs', mode: '0644' }
      - { ext: 'key', dir: 'private', mode: '0644' }
  tags:
    - pki
    - upload

- name: Validate Deployed Certificates
  community.crypto.x509_certificate_info:
    path: "{{ pki_output_folder }}/{{ item.name }}.crt"
  register: pki_cert_validation
  delegate_to: localhost
  become: false
  loop: "{{ pki_services }}"
  loop_control:
    label: "{{ item.name }}"
  tags:
    - pki
    - validate

- name: Verify Certificate Properties
  ansible.builtin.assert:
    that:
      - pki_cert_validation.results[ansible_loop.index0].subject.commonName == item.dns
      - pki_cert_validation.results[ansible_loop.index0].subject_alt_name | select('match', 'DNS:' + item.dns) | list | length > 0
      - pki_cert_validation.results[ansible_loop.index0].issuer.commonName == pki_ca_common_name
      - not pki_cert_validation.results[ansible_loop.index0].expired
    fail_msg: "Certificate validation failed for {{ item.name }}"
    success_msg: "Certificate {{ item.name }} is valid and properly configured"
  delegate_to: localhost
  become: false
  loop: "{{ pki_services }}"
  loop_control:
    label: "{{ item.name }}"
    extended: true
    extended_allitems: false
  tags:
    - pki
    - validate
