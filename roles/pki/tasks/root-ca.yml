- name: Check if Root CA already exists
  ansible.builtin.stat:
    path: "{{ pki_output_folder }}/authorities/root-ca.crt"
  register: pki_root_ca_exists
  delegate_to: localhost
  become: false
  tags:
    - pki

- name: Generate Root CA Infrastructure
  when: not pki_root_ca_exists.stat.exists
  block:
    - name: Generate Private Key for Lab
      community.crypto.openssl_privatekey:
        path: "{{ pki_output_folder }}/authorities/root-ca.key"
        type: "RSA"
        size: 4096
        state: present
        backup: true
      run_once: true
      delegate_to: localhost
      become: false
      tags:
        - pki

    - name: Generate Signing Request for Lab
      community.crypto.openssl_csr:
        path: "{{ pki_output_folder }}/authorities/root-ca.csr"
        privatekey_path: "{{ pki_output_folder }}/authorities/root-ca.key"
        backup: true

        # Certificate Metadata
        common_name: "{{ pki_ca_common_name }}"
        organization_name: "{{ pki_ca_organization }}"
        organizational_unit_name: "{{ pki_ca_organizational_unit }}"
        country_name: "{{ pki_ca_country }}"
        state_or_province_name: "{{ pki_ca_state }}"
        locality_name: "{{ pki_ca_locality }}"
        email_address: "{{ pki_ca_email }}"

        # Constraints for Root CA
        basic_constraints:
          - "CA:TRUE"
        basic_constraints_critical: true
        key_usage:
          - keyCertSign
          - cRLSign
          - digitalSignature
        key_usage_critical: true
      run_once: true
      delegate_to: localhost
      become: false
      tags:
        - pki

    - name: Generate Root Certificate Authority
      community.crypto.x509_certificate:
        path: "{{ pki_output_folder }}/authorities/root-ca.crt"
        privatekey_path: "{{ pki_output_folder }}/authorities/root-ca.key"
        csr_path: "{{ pki_output_folder }}/authorities/root-ca.csr"
        provider: selfsigned
        backup: true

        # Root CA Expiration
        selfsigned_not_after: "+3650d"
        selfsigned_not_before: "-1d"

        # Selfsigned options
        selfsigned_digest: sha512
      run_once: true
      delegate_to: localhost
      become: false
      tags:
        - pki

    - name: Generate PKCS#12 Certificate for Firefox
      community.crypto.openssl_pkcs12:
        action: export
        path: "{{ pki_output_folder }}/authorities/root-ca.p12"
        certificate_path: "{{ pki_output_folder }}/authorities/root-ca.crt"
        privatekey_path: "{{ pki_output_folder }}/authorities/root-ca.key"
        friendly_name: "Homelab Root CA"
        passphrase: "homelab"
        mode: '0644'
      delegate_to: localhost
      become: false
      tags:
        - pki

    - name: Create Browser Import Instructions
      ansible.builtin.copy:
        content: |
          # Homelab Root CA Certificate Import Instructions

          ## Firefox Import (Method 1 - PKCS#12 - RECOMMENDED):
          1. Open Firefox
          2. Go to Settings (about:preferences)
          3. Search for "certificates"
          4. Click "View Certificates"
          5. Go to "Authorities" tab
          6. Click "Import..."
          7. Select: {{ pki_output_folder }}/authorities/root-ca.p12
          8. Enter password: homelab
          9. Check "Trust this CA to identify websites"
          10. Click OK

          ## Firefox Import (Method 2 - CRT):
          1. Open Firefox
          2. Go to Settings (about:preferences)
          3. Search for "certificates"
          4. Click "View Certificates"
          5. Go to "Authorities" tab
          6. Click "Import..."
          7. Select: {{ pki_output_folder }}/authorities/root-ca.crt
          8. Check "Trust this CA to identify websites"
          9. Click OK

          ## Chrome/Chromium Import:
          1. Open Chrome Settings
          2. Go to Privacy and Security > Security
          3. Click "Manage certificates"
          4. Go to "Authorities" tab
          5. Click "Import"
          6. Select: {{ pki_output_folder }}/authorities/root-ca.crt
          7. Check "Trust this certificate for identifying websites"
          8. Click OK

          ## Command Line Verification:
          ```bash
          # View certificate details
          openssl x509 -in {{ pki_output_folder }}/authorities/root-ca.crt -text -noout

          # Verify certificate
          openssl verify -CAfile {{ pki_output_folder }}/authorities/root-ca.crt {{ pki_output_folder }}/authorities/root-ca.crt

          # View PKCS#12 contents
          openssl pkcs12 -in {{ pki_output_folder }}/authorities/root-ca.p12 -info -noout
          ```

          ## Files Generated:
          ### Certificate Authority Files:
          - {{ pki_output_folder }}/authorities/root-ca.crt (Root CA certificate)
          - {{ pki_output_folder }}/authorities/root-ca.key (Root CA private key - keep secure!)
          - {{ pki_output_folder }}/authorities/root-ca.p12 (PKCS#12 format - password: homelab)

          ### User Certificate Files:
          - {{ pki_output_folder }}/user_certs/ (Client certificates for user authentication)

          ## Security Notes:
          - The private key files should never be shared or moved from this machine
          - The .crt and .p12 files can be safely distributed to client machines
          - Certificate is valid for 10 years (3650 days)
          - PKCS#12 password is: homelab (change if needed for production)

          ## Recommended Import Method:
          Use the PKCS#12 file (root-ca.p12) for Firefox as it includes both
          certificate and key with matching names, ensuring better compatibility.
        dest: "{{ pki_output_folder }}/BROWSER_IMPORT_INSTRUCTIONS.md"
        mode: '0644'
      delegate_to: localhost
      become: false
      tags:
        - pki
