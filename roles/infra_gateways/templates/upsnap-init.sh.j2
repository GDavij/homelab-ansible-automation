#!/bin/bash
# Upsnap Initialization Script
# Auto-generated by Ansible for {{ inventory_hostname }}
# This script pre-configures devices in Upsnap using the PocketBase API

set -e

UPSNAP_URL="http://{{ upsnap_config.bind_address }}:{{ upsnap_config.web_port }}"
TIMEOUT=60
RETRY_DELAY=5

echo "Waiting for Upsnap to be ready..."

# Wait for Upsnap to be available
START_TIME=$(date +%s)
while true; do
    if curl -s -f "${UPSNAP_URL}/api/health" >/dev/null 2>&1; then
        echo "Upsnap is ready!"
        break
    fi
    
    CURRENT_TIME=$(date +%s)
    ELAPSED_TIME=$((CURRENT_TIME - START_TIME))
    if [[ $ELAPSED_TIME -ge $TIMEOUT ]]; then
        echo "Timeout reached. Upsnap did not become ready. Exiting."
        exit 1
    fi
    
    echo "Waiting for Upsnap to start... (${ELAPSED_TIME}s/${TIMEOUT}s)"
    sleep $RETRY_DELAY
done

# Function to add a device
add_device() {
    local name="$1"
    local ip="$2"
    local mac="$3"
    local description="$4"
    local ssh_enabled="$5"
    local ssh_username="$6"
    local ssh_port="$7"
    local ssh_key_path="$8"
    
    echo "Adding device: $name ($ip)"
    
    # Check if device already exists
    EXISTING_DEVICE=$(curl -s "${UPSNAP_URL}/api/collections/devices/records" | jq -r ".items[]? | select(.name == \"$name\") | .id" 2>/dev/null || echo "")
    
    if [[ -n "$EXISTING_DEVICE" ]]; then
        echo "Device $name already exists with ID: $EXISTING_DEVICE"
        return 0
    fi
    
    # Prepare device data (based on actual Upsnap device schema)
    DEVICE_DATA=$(jq -n \
        --arg name "$name" \
        --arg ip "$ip" \
        --arg mac "$mac" \
        --arg description "$description" \
        '{
            name: $name,
            ip: $ip,
            mac: $mac,
            description: $description,
            status: "unknown"
        }')
    
    # Add SSH configuration if enabled
    if [[ "$ssh_enabled" == "true" && -n "$ssh_key_path" ]]; then
        DEVICE_DATA=$(echo "$DEVICE_DATA" | jq \
            --arg ssh_username "$ssh_username" \
            --argjson ssh_port "$ssh_port" \
            --arg ssh_key_path "$ssh_key_path" \
            '. + {
                ssh_enabled: true,
                ssh_username: $ssh_username,
                ssh_port: $ssh_port,
                ssh_key_path: $ssh_key_path
            }')
    fi
    
    # Add the device
    RESPONSE=$(curl -s -X POST "${UPSNAP_URL}/api/collections/devices/records" \
        -H "Content-Type: application/json" \
        -d "$DEVICE_DATA")
    
    if echo "$RESPONSE" | jq -e '.id' >/dev/null 2>&1; then
        DEVICE_ID=$(echo "$RESPONSE" | jq -r '.id')
        echo "Successfully added device $name with ID: $DEVICE_ID"
    else
        echo "Failed to add device $name. Response: $RESPONSE"
        return 1
    fi
}

# Add configured machines
{% for machine in upsnap_machines %}
add_device \
    "{{ machine.name }}" \
    "{{ machine.ip }}" \
    "{{ machine.mac }}" \
    "{{ machine.description }}" \
    {% if machine.ssh_key is defined %}true{% else %}false{% endif %} \
    "{{ machine.username | default('root') }}" \
    {{ machine.ssh_port | default(22) }} \
    "{{ machine.ssh_key | default('') }}"
{% endfor %}

echo "Device initialization completed!"

{% if upsnap_config.auto_discovery.initial_scan %}
# Trigger initial network scan to discover devices
echo "Triggering initial network scan..."
curl -s "${UPSNAP_URL}/api/upsnap/scan" >/dev/null && echo "Network scan initiated" || echo "Network scan request sent"

# Wait a moment for the scan to start
sleep 2
{% endif %}

echo "Upsnap initialization completed successfully!"
echo "Configured devices:"
{% for machine in upsnap_machines %}
echo "  - {{ machine.name }} ({{ machine.ip }}) - {{ machine.description }}"
{% endfor %}
echo ""
echo "Upsnap is accessible at: ${UPSNAP_URL}"
echo "Use the web interface to manage devices and configure additional settings."