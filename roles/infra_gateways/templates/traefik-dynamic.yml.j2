{% if http_routers is defined and http_routers|length > 0 %}
http:
  routers:
{% for router in http_routers %}
    {{ router.name }}-router:
      rule: "{{ router.rule }}"
      entryPoints:
{% for entrypoints in router.entryPoints %}
        - {{ entrypoints }}
{% endfor %}
{% if router.internal is defined and router.internal %}
      service: api@internal
{% else %}
      service: {{ router.name }}-service
{% endif %}
      tls: {}
{% endfor %}

  services:
{% for router in http_routers %}
{% if router.internal is not defined %}
    {{ router.name }}-service:
      loadBalancer:
{% if router.mtls %}
        serversTransport: {{ router.name }}-transport
{% endif %}
        servers:
{% for server in router.service.loadBalancer.servers %}
          - url: "{{ server.url }}"
{% endfor %}
{% endif %}
{% endfor %}
{% endif %}

  middlewares:
    traefik-auth:
      basicAuth:
        users:
          - "{{ traefik_username }}:{{ traefik_password_hash }}"
    
    trilium-headers:
      headers:
        customRequestHeaders:
          X-Forwarded-Proto: "https"

{% if pki_services is defined and pki_services|length > 0 %}
  serversTransports:
{% for service in pki_services %}
    {{ service.name }}-transport:
      serverName: "{{ service.dns }}"
      insecureSkipVerify: false
      rootCAs:
        - /etc/traefik/certs/lab_root_ca.crt
      certificates:
        - certFile: /etc/traefik/certs/traefik.crt
          keyFile: /etc/traefik/certs/traefik.key
      maxIdleConnsPerHost: 42
      forwardingTimeouts:
        dialTimeout: 30s
        responseHeaderTimeout: 60s
        idleConnTimeout: 120s
        readIdleTimeout: 60s
{% endfor %}
{% endif %}

{% if tcp_routers is defined and tcp_routers|length > 0 %}
tcp:
  routers:
{% for router in tcp_routers %}
    {{ router.name }}-router:
      rule: "{{ router.rule }}"
      entryPoints:
{% for entrypoints in router.entryPoints %}
        - {{ entrypoints }}
{% endfor %}
  service: {{ router.name }}-service
      tls:
        passthrough: {{ router.tls.passthrough }}
{% endfor %}

  services:
{% for router in tcp_routers %}
    {{ router.name }}-service:
      loadBalancer:
        servers:
{% for server in router.service.loadBalancer.servers %}
          - address: "{{ server.address }}"
{% endfor %}
{% endfor %}

{% endif %}

{% if pki_services is defined and pki_services|length > 0 %}
tls:
  certificates:
{% for service in pki_services %}
  - certFile: /etc/traefik/certs/{{ service.name }}.crt
    keyFile: /etc/traefik/certs/{{ service.name }}.key
{% endfor %}
  options:
    default:
      minVersion: VersionTLS12
      maxVersion: VersionTLS13
      clientAuth:
        caFiles:
          - /etc/traefik/certs/lab_root_ca.crt
        clientAuthType: RequireAndVerifyClientCert
      sniStrict: true

{% endif %}